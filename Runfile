require "runfile-tasks"
require "byebug"
require_relative 'lib/slacktail'

title   "Slacktail Developer Toolbelt"
summary "Runfile tasks for building the Slacktail gem"
version Slacktail::VERSION

include Slacktail

RunfileTasks::RubyGems.all 'slacktail'
RunfileTasks::Testing.rspec

help   "Run interactive console"
action :console, :c do
  run "bundle exec bin/console"
end

help   "Test message rendering"
action :render do
  Client.default.start_async # in order to have channels and users list
  Message.new(message_mock).render
end

help   "Simulated run for recording the demo"
action :simulate do |args|
  client = Mocks::Client.new echo: false
  Client.default = client
  Command.new.run
  
  sleep 2
  mock = Mocks::Message.new(attachments: false, message: "I’ll never turn to the dark side. You’ve failed, your highness. I am a Jedi, like my father before me.")
  client.simulate :message, mock
  
  sleep 2
  mock = Mocks::Message.new(message2: '', user: :bot, color: 'ffff00', message: "*Build started* some.production.service.com")
  client.simulate :message, mock
  
  sleep 4
  mock = Mocks::Message.new(message2: '', user: :bot, color: 'ff0000', message: "**Build FAILED**:\n\nBuild number `45` failed in `production`")
  client.simulate :message, mock

  sleep 6
  mock = Mocks::Message.new(attachments: false, message: "Fixed, deploying again")
  client.simulate :message, mock
  
  sleep 3
  mock = Mocks::Message.new(message2: '', user: :bot, color: 'ffff00', message: "*Build started* some.production.service.com")
  client.simulate :message, mock
  
  sleep 4
  mock = Mocks::Message.new(message2: '', user: :bot, color: '00ff00', message: "**Build SUCCEEDED**:\n\nBuild number `45` deployed to `production`")
  client.simulate :message, mock

  sleep 10
end

def message_mock
  OpenStruct.new({
    text: "Hello tester",
    # bot_id: 'some-bot-id',
    user: "some-user-id",
    attachments: [
      OpenStruct.new({
        text: "*Build SUCCESS*: `stage-shutdown` *#45*",
        fields: [
          OpenStruct.new({ title: "Build Number", value: "45" }),
          OpenStruct.new({ title: "Env", value: "Production" }),
        ]
      })
    ]
  })
end

require_relative 'debug' if File.exist? 'debug.rb'